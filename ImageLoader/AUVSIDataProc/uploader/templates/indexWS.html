<!DOCTYPE html>
<html>
<head>
<title>Picture Viewer</title>
<script type="text/javascript" src="{{ STATIC_URL }}js/ws4redis.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!--<link rel="stylesheet" type="text/css" href="./style.css">-->

<style>
html{
  font-family: "Helvetica", sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
}
body {
  margin: 0;
}
table {
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 5px;
}
#left-panel
{        
    background-color:transparent;
    width:50%;
    float:left;
    overflow-y: scroll;
}
#right-panel
{        
    background-color:transparent;
    width:50%;
    float:left;
    overflow-y: scroll;
}
img {
  vertical-align: middle;
}
</style>


<script>
    var numcols=0;//set when the window loads
    var imgwidth=200;
    var counter=0;//counts the number of images added so far
    var image=document.focusedImage;
    window.onload = function displaying(){
        //making the grid and viewer panels the height of the window
        //if the window height changes, the page has to be reloaded
        //when the window cannot fit the grid vertically, we can scroll through them
        var height = window.innerHeight;
        document.getElementById("left-panel").style.maxHeight=height+'px';
        document.getElementById("right-panel").style.maxHeight=height+'px';
        //calculating the number of columns in the grid based on the sizes of panels and thumbnails
        var width = document.getElementById("right-panel").clientWidth;
        imgwidth = 200;
        var colwidth=imgwidth+2*5//image width + padding on both sides (hardcoded)
        numcols=Math.trunc(width/colwidth);
        if (numcols==0) numcols++;
    }

    $(document).ready(function(){
        //create websocket
        var web_socket = WS4Redis({
            uri:'{{WEBSOCKET_URI}}viewer?subscribe-broadcast&publish-broadcast&echo',
            //triggered when msg from server is sent
            receive_message: getPic,
            heartbeat_msg: {{WS4REDIS_HEARTBEAT}}

         });
        function getPic(msg){
            
            //msg is the image source
            var grid = document.getElementById('imagegrid');
           
            if (counter%numcols==0) {
                grid.appendChild(document.createElement("tr"));//adding a row
            }
            counter++;
            //finding the last row in the grid
            var rows = document.getElementsByTagName("tr");
            var row = rows[rows.length-1];
            //adding a column and the thumbnail
            var col = document.createElement("td");
            var img = document.createElement("img");

            var url = msg.substring(1,msg.length-1);

            img.src=url;
            img.width=imgwidth;//scale the images so that they all have the same width
            //selecting the image shown in the viewer
            img.addEventListener("click", function() {
                document.focusedImage.src=this.src;
                return false;
            });
            col.appendChild(img);
            row.appendChild(col);
        };
    });
    
    image.onload = function cropper() {
        var p1;
        var p2;
        var cropinit;
        var corner=new Array();
        var boxW;
        var boxH;
        var xOff;
        var yOff;

        function setBox() {
            boxW=p1[0]-p2[0];
            boxH=p1[1]-p2[1];
            //finding the top left corner
            if (boxW<0) {
                corner[0]=p1[0];
                boxW=-boxW;
            }
            else {
                corner[0]=p2[0];
            }
            if (boxH<0) {
                corner[1]=p1[1];
                boxH=-boxH;
            }
            else {
                corner[1]=p2[1];
            }
        }

        var canvas=document.getElementById("selector");
        canvas.width=image.width;
        canvas.height=image.height;
        var rect = canvas.getBoundingClientRect();//allows you to find the height and width by imagining a rectangle around it
        xOff=rect.top;
        yOff=rect.left;
        ctx=canvas.getContext("2d");
        ctx.fillStyle="rgba(210,220,255,0.6)";
        cropinit=false;
        //the cropped section will not be resizeable after the user finishes, but the user can create a new cropped section
        canvas.addEventListener("mousedown", function setP1(event) {
            p1=[event.clientX-xOff, event.clientY-yOff];
            cropinit=true;
        });
        //so that if the user releases the mouse after it leaves the canvas, the crop completes
        canvas.addEventListener("mouseleave", function() {
            cropinit=false;
        });
        canvas.addEventListener("mousemove", function drawBox(event) {
            if (cropinit) {
                p2=[event.clientX-xOff, event.clientY-yOff];
                setBox();
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillRect(corner[0],corner[1],boxW,boxH);
                //console.log(corner[0]+" "+corner[1]+" "+boxW+" "+boxH);
            }
        });
        canvas.addEventListener("mouseup", function finishBox(event) {
            p2=[event.clientX-xOff, event.clientY-yOff];
            setBox();
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillRect(corner[0],corner[1],boxW,boxH);
            cropinit=false;
            //console.log(corner[0]+" "+corner[1]+" "+boxW+" "+boxH);

    }
</script>
</head>

<body>
    <div id="left-panel">
        <div id="container" style="position: relative; cursor: crosshair;">
            <canvas id="selector" style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
            <img src="" name="focusedImage" alt="" style="position: absolute; top: 0; left: 0; z-index: 0;">        
        </div>
        <p>This is where image and target data could be displayed</p>
    </div>
    <div id="right-panel">
        <table id="imagegrid">
        </table>
    </div>
</body>

</html>