<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Picture Viewer</title>
<script type="text/javascript" src="{{ STATIC_URL }}js/ws4redis.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/spectrum.js"></script>
<script type="text/javascript" src="{{STATIC_URL}}js/ajaxsetup.js"></script>

<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/spectrum.css" />
<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/loader.css" />
<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}css/style.css" />

<script>
  curr = 0; //the id of the picture/target in focus
  picview = true;//true when a picture is in view, false when a target is in view
  loading = 1;
  img_properties = {}; //now using an object as a map since the images are not sent down in order
  crop = {};

  $(function connect_websocket_pic(){
      //create websocket
      var web_socket = WS4Redis({
      uri:"{{WEBSOCKET_URI}}viewer?subscribe-broadcast&publish-broadcast&echo",
      //triggered when msg from server is sent
      receive_message: parseWebSkt,
      heartbeat_msg: {{WS4REDIS_HEARTBEAT}}
      });
    }
  )

  //sets up form submission
  $(function form_submit_setup() {
    //on user submit
    $("#submit").on("click", function(event) {
      //allow for ajax
      event.preventDefault();
      //get all form attributes
      var inputs = $("#form").find(":input");
      //array of user inputs
      var input_array = {};
      //put each one in an array
      inputs.each(function() {
        if (this.name=="color" || this.name=="lcolor") {
          if (this.value=="") {
            input_array[this.name] = "0, 0, 0";
          }
          else {
            input_array[this.name] = this.value.substring(this.value.indexOf("(")+1,this.value.indexOf(")"));
          }
        }
        else {
          input_array[this.name] = this.value;
        }
      })
        //if there attributes, send them
      if(input_array) {
        if (picview) {
          //creating a new target
          $.ajax({
            url: "{% url 'attrform'%}",
            type: "POST",
            data: {"pk":curr,"attr":input_array,"crop":crop},
            success: function(json){
              //adding the target image
              var div = document.createElement("div");
              div.className = "thumb-div";
              image = document.createElement("img");
              image.className = "thumbnail";
              image.src = json.image;
              image.id = json.pk;
              image.addEventListener("click", function() {
                picview = false;
                setFocusedImage(this);
                return false;
              })
              div.appendChild(image);
              $("#targets").append(div);
            }
          });
        }
        else {
          //editing the shown target
          $.ajax({
            url: "{% url 'targetedit'%}",
            type: "POST",
            data: {"pk":curr,"attr":input_array},
            success: function(json){
              showTargetData($("#"+curr)[0]);
            }
          })
        }
      }
    })
  })

  //handles picture received from websocket
  function parseWebSkt(response){
    //parse json server response
    var json_response = JSON.parse(response);
    if (json_response.hasOwnProperty("disconnected")) {
      alert("Android Device Disconnected");
    }
    else if (json_response.hasOwnProperty("connected")) {
      alert("Android Device Connected");
    }
    else if (json_response.hasOwnProperty("type")) {
      if (loading==1) {
        loading = 0;
        return;
      }
      if (json_response["type"]== "picture") {
        var picture = JSON.parse(json_response.image.substring(json_response.image.indexOf("[")+1,json_response.image.indexOf("]")))
        var div = document.createElement("div");
        div.className = "thumb-div";
        var img = document.createElement("img");
        img.className = "thumbnail";
        var img_fields = picture.fields
        img.src= img_fields.fileName
        img.id=parseInt(picture.pk)
        img_properties[img.id]= img_fields
        img.addEventListener("click", function() {
          picview = true;
          setFocusedImage(this);
          return false;
        });
        div.appendChild(img);
        $("#pictures").append(div);
      }
    }
  }

  window.onload = function() {
    //making the grid and viewer panels the height of the window
    //if the window height changes, the page has to be reloaded
    var height = window.innerHeight - $("#trigger").height() - 30;
    $("#left-panel").css("max-height", height + "px");
    $("#pictures").css("max-height", height + "px");
    $("#targets").css("max-height", height + "px");
    var width = Math.trunc($(window).width());
    $("#left-panel").css("max-width", "500px");
    $("#pictures").css("max-width", (width - 500 - 170 - 100) + "px");
    $("#targets").css("max-width", "170px");
    //event listener for entire window (for keys)
    document.addEventListener("keyup", function(key) {
      var space = 32;
      var leftarrow = 37;
      var rightarrow = 39;
      var del = 46;
      switch (key.keyCode) {
        case leftarrow:
          var previmage = $("#"+curr).parent().prev().children()[0];
          if (previmage!=null) {
            setFocusedImage(previmage);
          }
          break;
        case rightarrow:
          var nextimage = $("#"+curr).parent().next().children()[0];
          if (nextimage!=null) {
            setFocusedImage(nextimage);
          }
          break;
        case del:
          //ajax request to server to delete image with curr as the picture/target object pk
          if (picview) {
            $.ajax({
              url:"{% url 'deletepic'%}",
              type:"POST",
              data: {"pk":curr},
            })
          }
          else {
            $.ajax({
              url:"{% url 'deletetarget'%}",
              type:"POST",
              data: {"pk":curr},
            })
          }
          //document.focusedImage.src = 0;
          var nextimage = $("#"+curr).parent().next().children()[0];
          $("#"+curr).parent().remove();
          if (nextimage!=null) {
            setFocusedImage(nextimage);
          }
          break;
      }
    });
  }

  //set the focusedImage to the given image, also changing the value of curr, and initializes the canvas
  function setFocusedImage(image) {
    if (picview) {
      document.focusedImage.src=image.src;
      //document.focusedImage.style.width = focusedwidth+"px";
      //document.focusedImage.style.height = "auto";
      curr=parseInt(image.id);
      canvasinit();//to resize the canvas and start a new crop
      //getting targets using the pk of the current image
      $("#focus-type").text("Picture Data");
      pic_curr_props = img_properties[image.id];//using the string id to access the data in the map
      $("#focus-data").empty()
        .append("<tr><td>Latitude</td><td>"+pic_curr_props.lat+"</td></tr>")
        .append("<tr><td>Longitude</td><td>"+pic_curr_props.lon+"</td></tr>")
        .append("<tr><td>Altitude</td><td>"+pic_curr_props.alt+"</td></tr>")
        .append("<tr><td>Azimuth</td><td>"+pic_curr_props.azimuth+"</td></tr>")
        .append("<tr><td>Pitch</td><td>"+pic_curr_props.pitch+"</td></tr>")
        .append("<tr><td>Roll</td><td>"+pic_curr_props.roll+"</td></tr>");
        //Add orientation
    }
    else {
      document.focusedImage.src=image.src;
      //document.focusedImage.style.width = focusedwidth+"px";
      //document.focusedImage.style.height = "auto";
      curr=parseInt(image.id);
      $("#selector").css("display","none");
      $("#focus-type").text("Target Data");
      showTargetData(image);
    }

  }

  function showTargetData(image) {
    pk = parseInt(image.id);
    $.ajax({
      url: "{% url 'gettargetdata'%}",
      type: "POST",
      dataType: "json",
      data: {"pk": pk},
      success: function(json) {
        $("#focus-data").empty()
          .append("<tr><td>Color</td><td>"+json.color+"</td></tr>")
          .append("<tr><td>Letter Color</td><td>"+json.lcolor+"</td></tr>")
          .append("<tr><td>Orientation</td><td>"+json.orientation+"</td></tr>")
          .append("<tr><td>Shape</td><td>"+json.shape+"</td></tr>")
          .append("<tr><td>Letter</td><td>"+json.letter+"</td></tr>")
          .append("<tr><td>Latitude</td><td>"+json.lat+"</td></tr>")
          .append("<tr><td>Longitude</td><td>"+json.lon+"</td></tr>");
        $("#lpalette").val(json.lcolor);
        $("#palette").val(json.color);
        $("#orientation").val(json.orientation);
        $("#shape").val(json.shape);
        $("#letter").val(json.letter);
      }
    })
  }

  //sets the canvas width and height and allows it to listen for cropping
  function canvasinit() {
    var p1;
    var p2;
    var cropinit;
    var corner = [];
    var boxW;
    var boxH;
    //set canvas to image params
    var canvas = document.getElementById("selector");
    canvas.width = document.focusedImage.width;
    canvas.height = document.focusedImage.height;
    canvas.style.display = "block";
    var ctx = canvas.getContext("2d");
    ctx.fillStyle="rgba(210,220,255,0.6)";
    //whether the cropping is taking place
    var cropinit=false;
    function setBox() {
      boxW = p1[0]-p2[0];
      boxH = p1[1]-p2[1];
      //finding the top left corner
      if (boxW<0) {
        corner[0] = p1[0];
        boxW = -boxW;
      }
      else {
        corner[0] = p2[0];
      }
      if (boxH<0) {
        corner[1] = p1[1];
        boxH = -boxH;
      }
      else {
        corner[1] = p2[1];
      }
      crop.corner = corner;
      crop.width = boxW;
      crop.height = boxH;
      crop.scaleWidth = document.focusedImage.width;
    }
    //the cropped section will not be resizeable after the user finishes, but the user can create a new cropped section
    canvas.addEventListener("mousedown", function setP1(event) {
      //allows you to find the height and width by imagining a rectangle around it
      //get bounding selector parameters
      p1 = [event.layerX, event.layerY];
      cropinit = true;
    });
    //so that if the user releases the mouse after it leaves the canvas, the crop completes
    canvas.addEventListener("mouseleave", function() {
      cropinit = false;
    });
    canvas.addEventListener("mousemove", function drawBox(event) {
      if (cropinit) {
        p2 = [event.layerX, event.layerY];
        setBox();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillRect(corner[0],corner[1],boxW,boxH);
      }
    });
    canvas.addEventListener("mouseup", function finishBox(event) {
      p2=[event.layerX, event.layerY];
      setBox();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillRect(corner[0],corner[1],boxW,boxH);
      cropinit = false;
    });
  }
</script>
</head>

<body>
  <div id="trigger">
    <form id="trigger_on_form">
      <input id="time_interval" type="text" value="0"/>
      <button onclick="trigger();" name="trigger_on" type="button" id="trigger_on" value="1">Start Triggering</button>
    <form/>
    <button onclick="set_smart_trigger();" name="smart_trigger" type="button" id="smart_trigger" value="0">Smart Trigger on</button>
  </div>
  <div id="left-panel">
    <div id="container">
      <canvas id="selector" style="position: absolute; z-index: 1; cursor: crosshair;"></canvas>
      <img src="" id="focused" name="focusedImage" alt="" style="position: relative; z-index: 0;">
    </div>
    <div id="form">
      {%csrf_token%}
      <form id="attr_form">
        <input name="color" type="text" id="palette"/>
        <input name="lcolor" type="text" id="lpalette"/>
        {{form.as_p}}
        <button type="button" id="submit"/>Submit</button>
      </form>
    </div>
    <div id="data">
      <h3 id="focus-type">Picture Data</h3>
      <table id="focus-data">

      </table>
    </div>
  </div>
  <div id="pictures"></div>
  <div id="targets"></div>
</body>
</html>

<script>
$(document).ready(function(){
  //Colors: White, Black, Gray, Red, Blue, Green, Yellow, Purple, Brown, or Orange
  $("#palette").spectrum({
    showPaletteOnly: true,
    showPalette:true,
    color: "black",
    palette: [
        ["black", "white", "gray", "red", "blue"],
        ["green", "yellow", "purple", "brown", "orange"]
    ]
  });
});

$(document).ready(function(){
  $("#lpalette").spectrum({
    showPaletteOnly: true,
    showPalette:true,
    color: "black",
    palette: [
      ["black", "white", "gray", "red", "blue"],
      ["green", "yellow", "purple", "brown", "orange"]
    ]
  });
});

function set_smart_trigger(){
  var smart_trigger= document.getElementById("smart_trigger")
  $("#smart_trigger").val(Math.abs(smart_trigger.value-1))
  if(smart_trigger.value==false){
    $("#smart_trigger").html("Smart Triggering On")
  }
  else {
    $("#smart_trigger").html("Smart Triggering Off")
  }
}

function trigger() {
  $.ajax({
    url:"{%url 'gcstrigger' %}",
    type:"POST",
    dataType:"JSON",
    data:{"time":$("#time_interval").val(),"trigger":$("#trigger_on").val(),"smart_trigger":$("#smart_trigger").val()},
    success: function(json) {
      if (json.hasOwnProperty("failure")) {
        alert("Invalid Time Interval")
        return;
      }
      if (json.hasOwnProperty("nothing")) {
        return;
      }
      var time_int = document.getElementById("time_interval");
      time_int.value=0;
      var trigger_on = document.getElementById("trigger_on");
      $("#trigger_on").val(Math.abs(trigger_on.value-1));
      if (trigger_on.value==0) {
        $("#trigger_on").html("Stop Triggering");
      }
      else {
        $("#trigger_on").html("Start Triggering");
      }
    }
  })
}
</script>
