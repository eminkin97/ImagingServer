<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Picture Viewer</title>
<script type="text/javascript" src="{{ STATIC_URL }}js/ws4redis.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>



<script src='{{STATIC_URL}}js/spectrum.js'></script>
<link rel='stylesheet' href='{{STATIC_URL}}css/spectrum.css' />
<link rel='stylesheet' href='{{STATIC_URL}}css/loader.css' />

<script>
    var numcols=0;//set when the window loads
    var imgwidth=200;
    var counter=0;//counts the number of images added so far
    var curr_pic;//the id of the image in focus
    var crop = {}

    $(function connect_websocket(){

            //create websocket
            var web_socket = WS4Redis({
            uri:'{{WEBSOCKET_URI}}viewer?subscribe-broadcast&publish-broadcast&echo',
            //triggered when msg from server is sent
            receive_message: getPic,
            heartbeat_msg: {{WS4REDIS_HEARTBEAT}}

         });
        }
    )

    //cookie setup for posts
    $(function ajax_setup(){
            //get cookie for form posting
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) == (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            var csrftoken = getCookie('csrftoken');

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }


            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            })
        }
    )

    //sets up form submission
    $(function form_submit_setup(){

        //on user submit
        $('#submit').on('click',
            function(event){

                  //allow for ajax
               event.preventDefault()


                //get all form attributes
               var inputs = $('#attr_form').find(':input')


               //array of user inputs
               var input_array = {}

               //put each one in an array
               inputs.each(function(){
                    console.log(this.name)
                    console.log($(this).val())

                    input_array[this.name]=$(this).val()

               })

               console.log(input_array)
                //if there attributes, send them
                if(input_array){
                  $.ajax({
                        url: "{% url 'attrform'%}",
                        type: "POST",
                        data: {"pk":curr_pic,"attr":input_array,'crop':crop},

                        }
                    )

                }

            }
        )

    })




    //handles picture received from websocket
    function getPic(response){
        //parse json server response
       var json_response = JSON.parse(response);

        console.log("pic"+json_response.pk+" recieved")

        var grid = document.getElementById('imagegrid');

        if (counter%numcols==0) {
            grid.appendChild(document.createElement("tr"));//adding a row
        }
        counter++;
        //finding the last row in the grid
        var rows = document.getElementsByTagName("tr");
        var row = rows[rows.length-1];
        //adding a column and the thumbnail
        var col = document.createElement("td");
        var img = document.createElement("img");

        //crab the image url
        img.src=json_response.image;
        img.id=json_response.pk;
        img.width=imgwidth;//scale the images so that they all have the same width
        img.addEventListener("click", function() {
            setFocusedImage(this);
            return false;
        });

        col.appendChild(img);
        row.appendChild(col);
    }

    window.onload = function(){
        //making the grid and viewer panels the height of the window
        //if the window height changes, the page has to be reloaded
        //when the window cannot fit the grid vertically, we can scroll through them
        var height = window.innerHeight;
        document.getElementById("left-panel").style.maxHeight=height+'px';
        document.getElementById("right-panel").style.maxHeight=height+'px';
        //calculating the number of columns in the grid based on the sizes of panels and thumbnails
        var width = document.getElementById("right-panel").clientWidth;
        imgwidth = 200;
        var colwidth=imgwidth+2*5//image width + padding on both sides (hardcoded)
        numcols=Math.trunc(width/colwidth);
        if (numcols==0) numcols++;

        //event listener for entire window (for keys)
        document.addEventListener("keyup", function(key){
            var space=32;
            var leftarrow = 37;
            var rightarrow = 39;
            var deletearrow = 46
            //http://stackoverflow.com/questions/2876275/what-are-the-ascii-values-of-up-down-left-right
            switch (key.keyCode) {
                case leftarrow:
                    //need to find the index of the current focused image, based on the id curr_pic
                    var gallery = document.getElementById("imagegrid").getElementsByTagName("img");
                    var currimage = document.getElementById(curr_pic);
                    var index = $.inArray(currimage, gallery);
                    index--;
                    if (index<0) break;//do nothing if there are no images before
                    currimage = gallery[index];//the new image
                    setFocusedImage(currimage);
                    break;
                case rightarrow:
                    //need to find the index of the current focused image, based on the id curr_pic
                    var gallery = document.getElementById("imagegrid").getElementsByTagName("img");
                    var currimage = document.getElementById(curr_pic);
                    var index = $.inArray(currimage, gallery);
                    index++;
                    if (index>=gallery.length) break;//do nothing if there are no images after
                    currimage = gallery[index];//the new image
                    setFocusedImage(currimage);
                    break;
                //deletes imagesz
                case deletearrow:
                    //ajax request to server to delete image with
                    //curr_pic as the picture object pk
                    $.ajax({
                        url:"{% url 'deletepic'%}",
                        type:"POST",
                        data: {"pk":curr_pic},

                    })
                    break

                default:
                    return;
            }
        });
        //document.focusedImage.onload = canvasinit();
    }

    //set the focusedImage to the given image, also changing the curr_pic, and initializes the canvas
    function setFocusedImage(image) {
        document.focusedImage.src=image.src;
        curr_pic=image.id;
        canvasinit();//to resize the canvas and start a new crop
        //getting targets using the pk of the current image
        //Also need to get picture metadata and display it--also useful for creating the compass rose
        $.ajax({
          url: "{% url 'gettargets'%}",
          type: "GET",
          dataType: "json",
          data: {"pk": image.id},
          success: function (json){
            json_response=JSON.parse(json);
            arr=json_response.targets;
            //should get a json with target pks mapped to their urls
            td = $.("#target-data");
            td.empty();
            for (i in arr) {
              image=document.createElement("img");
              image.src=i.image;
              image.id=i.pk;//this won't work if django repeats pk ids for different models...
              image.width=imgwidth;//so all the targets are shown as thumbnails
              td.appendChild(image);
            }
          }
        })
    }

    //sets the canvas width and height and allows it to listen for cropping
    function canvasinit() {
        var p1;
        var p2;

        var cropinit;
        var corner=new Array();
        var boxW;
        var boxH;
        var xOff;
        var yOff;

        //finding the coordinates of the top left corner of the image, which must be subtracted from the coordinates of the mouse events to find the coordinates within the image
        var image_position = document.focusedImage.getBoundingClientRect();
        xOff=image_position.top;
        yOff=image_position.left;

        //set canvas to image params
        var canvas = $('#selector')[0];
        canvas.width=document.focusedImage.width;
        canvas.height=document.focusedImage.height;

        var ctx = canvas.getContext("2d");
        ctx.fillStyle="rgba(210,220,255,0.6)";

        //whether the cropping is taking place
        var cropinit=false;

        function setBox() {
            boxW=p1[0]-p2[0];
            boxH=p1[1]-p2[1];
            //finding the top left corner

            if (boxW<0) {
                corner[0]=p1[0];
                boxW=-boxW;
            }
            else {
                corner[0]=p2[0];
            }
            if (boxH<0) {
                corner[1]=p1[1];
                boxH=-boxH;
            }
            else {
                corner[1]=p2[1];
            }

            crop.corner = corner;
            crop.width = boxW;
            crop.height = boxH;
        }

        //the cropped section will not be resizeable after the user finishes, but the user can create a new cropped section
        canvas.addEventListener("mousedown", function setP1(event) {
            //allows you to find the height and width by imagining a rectangle around it
            //get bounding selector parameters
            p1=[event.clientX-xOff, event.clientY-yOff];
            cropinit=true;
        });
        //so that if the user releases the mouse after it leaves the canvas, the crop completes
        canvas.addEventListener("mouseleave", function() {
            cropinit=false;
        });
        canvas.addEventListener("mousemove", function drawBox(event) {
            if (cropinit) {
                p2=[event.clientX-xOff, event.clientY-yOff]
                setBox();
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillRect(corner[0],corner[1],boxW,boxH);
            }
        });
        canvas.addEventListener("mouseup", function finishBox(event) {
            p2=[event.clientX-xOff, event.clientY-yOff];
            setBox();
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillRect(corner[0],corner[1],boxW,boxH);
            cropinit=false;
        });
    }

</script>
</head>

<body>
    <div id="left-panel">
        <div id="container" style="cursor: crosshair;">
            <canvas id="selector" style="position: absolute; z-index: 1;"></canvas>
            <img src="" name="focusedImage" alt="" style="position: relative; z-index: 0;">
        </div>
        <p id="descr">This is where image and target data could be displayed</p>
        <div id="target-data"></div>
        {%csrf_token%}
        <form id="attr_form">
            <input name="color" type='text' id="palette"/>
            <button type="button" id="submit"/>Submit</button>
        </form>


    </div>
    <div id="right-panel">
        <table id="imagegrid">
        </table>
        <!--Change this from a table to a list of images w/ automatic wrapping so that images can be easily deleted-->
    </div>
</body>

</html>

<script>

$(document).ready(function(){
//Colors: White, Black, Gray, Red, Blue, Green, Yellow, Purple, Brown, or Orange
    $("#palette").spectrum({
        showPaletteOnly: true,
        showPalette:true,
        color: 'black',
        palette: [
            ['black', 'white', 'gray', 'red', 'blue'],
            ['green', 'yellow', 'purple', 'brown', 'orange']
        ]
    });
/*
    $("#flat").spectrum({
        flat:true,
        showInput:true,
        allowEmpty:true
    });

    var flat = document.getElementById('flat')
*/
});

</script>
