<html>
	<head>
		<script>
		
		/*How to use front-end of this file: open in it chrome. As it is now, one picture and 3 buttons will be loaded onto the screen.  If you want to crop the
		image, click on the image and drag the mouse to another spot on the image, then let go of the mouse clicker. After you let go, a dotted white box will
		appear, previewing your crop. To actually crop the image, click the crop button.  Note that the crop button will not do anything if you don't have a dotted
		box on the image.  If you want to revert back to the original, uncropped image, click the Revert to Original Image Button.  If you click the save button,
		nothing really happens, you'll just get an alert box and a console log.  However, that console log is a meta-data string that tells you how to save the
		cropped image.  If you go to a python command line, cd into the directory containing the image, then copy paste that string into the python command line,
		then python will edit the actual image file on your computer such that it is cropped exactly as you saw it on the html document.
		*/
		
		/*If you want to load more images onto the document: go to the 3rd to last line of this file, and edit that line. It currently reads the following:
		addPicsToDocument(["sample_pic.jpeg"]);      If you want to add more images, add the file paths for those images into the array.  Note that this
		also works with urls, although the python code logged to the console by the save button will not work for urls.
		*/
		
		/* Explaining the back-end of this file: All important image data is saved in a window variable called img_data. img_data is an array and looks 
		something like this: [img1_data, img2_data, img3_data,...]. img1_data, img2_data, img3_data, ... are also arrays themselves.  Here is a closer look
		at img1_data: [img1_current_crop, img1_point1, img2_point2, img1_object].  img1_current_crop is also an array.  It looks like this:
		[bound_left, bound_top, bound_width, bound_height]. Those 4 values define a rectangle that defines the current crop.  For example,
		an img1_current_crop value of [10, 20, 100, 200] means that the cropped image is 100 pixels wide and 200 pixels tall, and the top left corner of the
		cropped image is 10 pixels to the right of and 20 pixels below the top left corner of the original image.  When images get rendered onto this page, they
		originally start off with current_crop values of [0, 0, width_of_original_image, height_of_original_image].  The only way to change an image's current_crop 
		value is to click on the Crop button for that image.  When you click the crop button, javascript looks at what point1 and point2 are set to, and sets
		current_crop based on those values.  Any image's point1 value originally starts off as [0,0], but it changes whenever you click down on an image, 
		and point2 originally starts off as (width_of_original_image, height_of_original_image), but it changes whenever you release the mouse clicker.  So
		clicking down on an image sets point1, and releasing the click sets point2, and those two points define a crop rectangle, and in fact after you release the click,
		javascript will draw a dottted white box over the image, signifying your bounding rectangle.  Then when you click the crop button, javascript sets current_crop
		based on point1 and point2 and cuts off the display of any parts of the image that are outside the bounding rectangle.  By the way, javascript also uses
		current_crop when you click the save button to generate the corresponding python code that will crop the actual image file.  Finally, the last element of img1_data
		is img1_object.  That object has a pointer pointing to the original source file or source url for the image, which is important to keep track of because javascript
		needs it in order for the Revert to Original Image button to work.  So in summary, when you load img1 onto the document (lets say img1 is 1000 x 1200 pixels),
		img1_data looks like this: [[0, 0, 1000, 1200], [0,0], [1000, 1200], img1_ojbect].  After interacting with the front-end interface for a bit though,
		img1_data may look like this: [[50, 100, 400, 500], [50, 40], [450, 600], img1_object].
		*/
		
		
		
			var img_data = [];													//initialize img_data window variable
			function addPicsToDocument(src_list) {
				var number_of_imgs_already_on_page = img_data.length;			//exactly one entry in img_data for one image, so number of images already on page = img_data.length
				for (var i = 0; i<src_list.length; i++) {
					var src = src_list[i];
					var id = number_of_imgs_already_on_page + i;
					img_data.push(["current_crop_placeholder", "point1_placeholder", "point2_placeholder", "img_object_placeholder"]);
					addPicToDocument(src, id);
				}
			};
			function addPicToDocument(src, id) {
				var image = document.createElement("img");
				image.src = src;
				image.onload = function() {
					var width = this.naturalWidth;												//width of original image
					var height = this.naturalHeight;											//height of original image
					img_data[id-1] = [[0, 0, width, height], [0,0], [width, height], image];	//initialize entry in img_data for this image
					var container = document.createElement("div");								//one div container for each img, div container will contain canvas element and 3 button elements
					container.id = id;
					document.body.appendChild(container);										//render div onto document
					var canvas = document.createElement("canvas");
					canvas.width = width;														//set width of canvas equal to width of original image
					canvas.height = height;														//set height of canvas equal to height of original image
					canvas.style.border = "1px solid #d3d3d3";
					canvas.addEventListener("mousedown", setPoint1, true);
					canvas.addEventListener("mouseup", setPoint2, true);
					container.appendChild(canvas);												//add the canvas to the div container
					var ctx = canvas.getContext("2d");
					ctx.drawImage(image, 0, 0);													//render the original image onto the canvas
					var crop_button = document.createElement("button");
					crop_button.innerHTML = "Crop";
					crop_button.onclick = function() {
						crop(id);
					};
					container.appendChild(crop_button);											//add the crop button to the div container
					var revert_to_original_button = document.createElement("button");
					revert_to_original_button.innerHTML = "Revert to Original Image";
					revert_to_original_button.onclick = function() {
						revertToOriginalImage(id);
					};
					container.appendChild(revert_to_original_button);							//add the Revert to Original Image button to the div container
					var save_button = document.createElement("button");
					save_button.innerHTML = "Save";
					save_button.onclick = function() {
						saveImage(id);
					};
					container.appendChild(save_button);											//add the Save button to the div container
				};
			};
			
			//given an html element, will return the absolute position of its upper left corner on the html document
			function getPosition(element) {													
				var xPosition = 0;
				var yPosition = 0;
      
				while (element) {
					xPosition += (element.offsetLeft - element.scrollLeft + element.clientLeft);
					yPosition += (element.offsetTop - element.scrollTop + element.clientTop);
					element = element.offsetParent;
				}
				return [xPosition, yPosition];
			};
			
			//this function gets called when you click down on an image.  The function figures out where you clicked, relative to the upper left corner of the image, and sets point1 for that image equal to where you clicked
			function setPoint1(mouse_down_event) {
				var element = mouse_down_event.currentTarget;							//element you clicked down on
				var id = element.parentNode.id;											//id of parent div container
				var pic_position = getPosition(element);								//absolute position of upper left corner of image you clicked on
				var absoulte_click_positionX = mouse_down_event.clientX;				//absolute x position of click
				var absolute_click_positionY = mouse_down_event.clientY;				//absolute y position of click
				var pic_click_positionX = absoulte_click_positionX - pic_position[0];	//mouse_down_event.clientX
				var pic_click_positionY = absolute_click_positionY - pic_position[1];
				img_data[id-1][1] = [pic_click_positionX, pic_click_positionY];			//set point1
			};
			//this function gets called when you release the clicker while on an image. The function figures out where your mouse was when you released, relativ to the upper left corner of the image, and sets point2 for that image equal to where you released. Also, this function calls the function the draws the white dotted bounding box
			function setPoint2(mouse_up_event) {
				var element = mouse_up_event.currentTarget;
				var id = element.parentNode.id;
				var pic_position = getPosition(element);
				var absolute_release_positionX = mouse_up_event.clientX;
				var absolute_release_positionY = mouse_up_event.clientY;
				var pic_release_positionX = absolute_release_positionX - pic_position[0];
				var pic_release_positionY = absolute_release_positionY - pic_position[1];
				img_data[id-1][2] = [pic_release_positionX, pic_release_positionY];		//set point2
				drawCropArea(id);														//after setting point2, draw the dotted white bounding box based on point1 and point2
			};
			
			//This function only ever gets called internally by the setPoint2 function.  It draws the white dotted bounding box based on point1 and point2
			function drawCropArea(id) {
				var img_datum = img_data[id-1];											//img_data just for the image that you are working with
				previous_crop = img_datum[0];
				var x1 = img_datum[1][0];
				var x2 = img_datum[2][0];
				var y1 = img_datum[1][1];
				var y2 = img_datum[2][1];
				var bound_left = Math.min(x1, x2);
				var bound_top = Math.min(y1, y2);
				var cropped_width = Math.abs(x1 - x2);
				var cropped_height = Math.abs(y1 - y2);
				var ctx = document.getElementById(id).getElementsByTagName("canvas")[0].getContext("2d");
				ctx.drawImage(img_datum[3], previous_crop[0], previous_crop[1], previous_crop[2], previous_crop[3], previous_crop[0], previous_crop[1], previous_crop[2], previous_crop[3]); //redraw the image onto the screen with the current crop, so that any previous dotted white bounding boxes will disappear from the screen before drawing the new white bounding box
				ctx.lineWidth = "5";																//make sure the box is drawn wide enough to be visible
				ctx.strokeStyle = "white";															//make sure the box is white
				ctx.setLineDash([15]);																//make sure the box is dotted (aka dashed)
				ctx.strokeRect(bound_left, bound_top, cropped_width, cropped_height);				//draw the dotted white bounding box
			};
			
			//This next function gets called whenever you click the Crop button.  It looks at point1 and point2 to set current_crop and turns off the display for any parts of the image outside the bounding box defined by point1 and point2
			function crop(id) {
				var img_datum = img_data[id-1];
				var x1 = img_datum[1][0];
				var x2 = img_datum[2][0];
				var y1 = img_datum[1][1];
				var y2 = img_datum[2][1];
				var bound_left = Math.min(x1, x2);
				var bound_top = Math.min(y1, y2);
				var cropped_width = Math.abs(x1 - x2);
				var cropped_height = Math.abs(y1 - y2);
				img_data[id-1][0] = [bound_left, bound_top, cropped_width, cropped_height];			//set current_crop
				var canvas = document.getElementById(id).getElementsByTagName("canvas")[0];
				var ctx = canvas.getContext("2d");
				ctx.fillStyle = "white";					
				ctx.fillRect(0, 0, canvas.width, canvas.height);									//first, make the entire canvas white
				ctx.drawImage(img_datum[3], bound_left, bound_top, cropped_width, cropped_height, bound_left, bound_top, cropped_width, cropped_height);	//redraw the portion of the image inside the bounding box
			};	
			
			//This function gets called whenever you click the Revert to Original Image button.  It uncrops the image, so that you can see the whole thing
			function revertToOriginalImage(id) {
				var canvas = document.getElementById(id).getElementsByTagName("canvas")[0];
				img_data[id-1][1] = [0,0];								//reset point1 to (0,0)
				img_data[id-1][2] = [canvas.width, canvas.height];		//reset point2 to (width_of_original_image, height_of_original_image)
				crop(id);												//crop the image based on the reset values of point1 and point2, has the effect of redisplaying the entire image
			};
			
			//This function gets called whenever you click the Save button.  It doesn't do anything except give you an alert box and log a message to the console.  That message logged to the console can be copy pasted into a python command line to actually edit an image file (after cd-ing into the directory containing the image file)
			function saveImage(id) {
				alert("functionality not added.  check console for generated python code");
				var img_datum = img_data[id-1];
				var full_file_path = img_datum[3].src;
				var index_of_last_slash = full_file_path.lastIndexOf("/");
				var file_path = full_file_path.substring(index_of_last_slash+1);
				var current_crop = img_datum[0];
				var bound_left = current_crop[0];
				var bound_top = current_crop[1];
				var bound_width = current_crop[2];
				var bound_height = current_crop[3];
				var python_code = "";
				python_code += "\nimport cv2";
				python_code += "\noriginal_image = cv2.imread(\"" + file_path + "\")";
				python_code += "\ncropped_image = original_image[" + bound_top + ": " + (bound_top+bound_height) + ", " + bound_left + ": " + (bound_left+bound_width) + "]";
				python_code += "\ncv2.imwrite(\"" + file_path +"\", cropped_image)";
				console.log(python_code);
			}
		</script>
	</head>
	<body>
		<script>
			//this is the line that actually adds pictures to the html document, edit this line if you want to add more pictures
			addPicsToDocument(["sample_pic.jpeg"]);
		</script>
	</body>